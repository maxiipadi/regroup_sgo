{% extends 'core/base.html' %}
{% load static %}
{% load static %}

{% block content %}
<style>
    :root {
        --mars-red: #CD5C5C;
        --space-black: #0a0e27;
        --star-white: #E8E8E8;
        --cosmic-blue: #06FFA5;
        --warning-orange: #FF6B35;
    }

    /* Sección principal con fondo espacial */
    .treatment-section {
        background: linear-gradient(135deg, var(--space-black) 0%, #1a1e3e 100%);
        min-height: 100vh;
        padding: 80px 0;
        position: relative;
        overflow: hidden;
    }

    .treatment-section::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: 
            radial-gradient(2px 2px at 20% 30%, white, transparent),
            radial-gradient(2px 2px at 60% 70%, white, transparent),
            radial-gradient(1px 1px at 50% 50%, white, transparent),
            radial-gradient(1px 1px at 80% 10%, white, transparent),
            radial-gradient(2px 2px at 90% 60%, white, transparent);
        background-size: 200px 200px;
        opacity: 0.3;
        animation: stars-movement 50s linear infinite;
    }

    @keyframes stars-movement {
        from { background-position: 0 0; }
        to { background-position: -200px 200px; }
    }

    .treatment-section .container {
        position: relative;
        z-index: 1;
    }

    /* Título principal */
    .treatment-title {
        font-size: 3.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 1.5rem;
        background: linear-gradient(90deg, var(--warning-orange), var(--mars-red));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 40px rgba(255, 107, 53, 0.3);
    }

    .treatment-subtitle {
        text-align: center;
        font-size: 1.3rem;
        color: var(--star-white);
        margin-bottom: 4rem;
        opacity: 0.9;
    }

    /* Tarjetas de tratamiento */
    .treatment-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 107, 53, 0.3);
        border-radius: 20px;
        padding: 35px;
        height: 100%;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .treatment-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 107, 53, 0.1), transparent);
        transition: left 0.5s;
    }

    .treatment-card:hover::before {
        left: 100%;
    }

    .treatment-card:hover {
        transform: translateY(-15px) scale(1.02);
        border-color: var(--warning-orange);
        box-shadow: 0 20px 60px rgba(255, 107, 53, 0.4);
    }

    .treatment-card h5 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--star-white);
    }

    .treatment-card .card-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        display: block;
        filter: drop-shadow(0 0 15px currentColor);
    }

    .treatment-card p {
        color: rgba(232, 232, 232, 0.8);
        line-height: 1.7;
        margin-bottom: 25px;
    }

    /* Botones espaciales */
    .btn-space {
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.3), rgba(205, 92, 92, 0.3));
        border: 2px solid;
        color: var(--star-white);
        padding: 12px 30px;
        border-radius: 30px;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-space::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn-space:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-space:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(255, 107, 53, 0.5);
        border-color: var(--warning-orange);
    }

    .btn-space-primary {
        border-color: #3b82f6;
    }

    .btn-space-danger {
        border-color: #ef4444;
    }

    .btn-space-warning {
        border-color: var(--warning-orange);
    }

    .btn-space-success {
        border-color: #10b981;
    }

    /* Formulario de ideas */
    .creative-form {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
    }

    .creative-form label {
        color: var(--cosmic-blue);
        font-weight: 600;
        margin-bottom: 10px;
    }

    .creative-form textarea {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--star-white);
        border-radius: 10px;
        padding: 15px;
        transition: all 0.3s ease;
    }

    .creative-form textarea:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--cosmic-blue);
        box-shadow: 0 0 20px rgba(6, 255, 165, 0.3);
        color: var(--star-white);
    }

    .creative-form textarea::placeholder {
        color: rgba(232, 232, 232, 0.5);
    }

    /* Modal espacial */
    .modal-space .modal-content {
        background: linear-gradient(135deg, #1a1e3e 0%, var(--space-black) 100%);
        border: 2px solid var(--warning-orange);
        border-radius: 20px;
        color: var(--star-white);
    }

    .modal-space .modal-header {
        border-bottom: 2px solid rgba(255, 107, 53, 0.3);
    }

    .modal-space .modal-footer {
        border-top: 2px solid rgba(255, 107, 53, 0.3);
    }

    .modal-space .modal-title {
        color: var(--warning-orange);
        font-weight: 700;
    }

    /* Animación de procesamiento */
    .processing-animation {
        text-align: center;
        padding: 40px;
    }

    .spinner-custom {
        width: 80px;
        height: 80px;
        border: 5px solid rgba(255, 107, 53, 0.2);
        border-top: 5px solid var(--warning-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .result-animation {
        animation: fadeInScale 0.5s ease-out;
    }

    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .result-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        filter: drop-shadow(0 0 20px currentColor);
        animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
        0%, 100% { filter: drop-shadow(0 0 20px currentColor); }
        50% { filter: drop-shadow(0 0 35px currentColor); }
    }

    .graph-container {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 107, 53, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin-top: 25px;
    }

    .graph-container img {
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .treatment-title {
            font-size: 2.5rem;
        }
        
        .treatment-subtitle {
            font-size: 1.1rem;
        }
        
        .treatment-card {
            padding: 25px;
        }
    }

    /* Vista de Proceso */
.treatment-card {
    background-color: #1c1f26;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.05);
    color: #e2e8f0;
}

.treatment-card h5 {
    font-size: 1.3rem;
    margin-bottom: 15px;
    color: var(--cosmic-blue);
}

.treatment-card p {
    font-size: 1rem;
    color: #cbd5e1;
}

.card-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
    display: block;
    text-align: center;
}

/* Accordion */
.accordion-button {
    background-color: #2a2e39;
    color: #e2e8f0;
    font-weight: 500;
    border: none;
    box-shadow: none;
    transition: background-color 0.3s ease;
}

.accordion-button:hover {
    background-color: #3b4252;
}

.accordion-button:not(.collapsed) {
    background-color: #3b82f6;
    color: #fff;
}

.accordion-body {
    background-color: #1f232b;
    color: #d1d5db;
    padding: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

/* Tabla de parámetros */
.table {
    background-color: #1f232b;
    color: #e2e8f0;
    font-size: 0.95rem;
}

.table thead {
    background-color: #2d3340;
    color: #93c5fd;
}

.table-bordered th,
.table-bordered td {
    border-color: rgba(255, 255, 255, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
    .treatment-card {
        padding: 20px;
    }

    .accordion-button {
        font-size: 0.95rem;
    }

    .table {
        font-size: 0.85rem;
    }
}

</style>

<section class="treatment-section">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="treatment-title">
                Tratamiento de Residuos No Reciclables
            </h1>
            <p class="treatment-subtitle">
                Estrategias avanzadas para manejar residuos imposibles de reciclar en Marte
            </p>
        </div>

        <div class="row g-4">
            <!-- Compactación -->
            <div class="col-md-6">
                <div class="treatment-card">
                    <i class="bi bi-box-fill card-icon" style="color: #3b82f6;"></i>
                    <h5>
                        <i class="bi bi-box-fill text-primary"></i> Compactación y Almacenamiento
                    </h5>
                    <p>
                        Los residuos se compactan mediante prensas hidráulicas de alta presión y se almacenan en contenedores blindados especiales para su posterior análisis científico o retorno programado a la Tierra.
                    </p>
                    <button class="btn btn-space btn-space-primary w-100" onclick="simular('compactacion')">
                        <i class="bi bi-arrow-right-circle me-2"></i> Iniciar Compactación
                    </button>
                </div>
            </div>

            <!-- Incineración -->
            <div class="col-md-6">
                <div class="treatment-card">
                    <i class="bi bi-fire card-icon" style="color: #ef4444;"></i>
                    <h5>
                        <i class="bi bi-fire text-danger"></i> Incineración Controlada
                    </h5>
                    <p>
                        Proceso de combustión a alta temperatura con sistema avanzado de filtrado de aire que neutraliza contaminantes, reduciendo el volumen hasta un 87% sin comprometer la atmósfera del hábitat marciano.
                    </p>
                    <button class="btn btn-space btn-space-danger w-100" onclick="simular('incineracion')">
                        <i class="bi bi-arrow-right-circle me-2"></i> Iniciar Incineración
                    </button>
                </div>
            </div>

            <!-- Energía -->
            <div class="col-md-6">
                <div class="treatment-card">
                    <i class="bi bi-lightning-fill card-icon" style="color: var(--warning-orange);"></i>
                    <h5>
                        <i class="bi bi-lightning-fill text-warning"></i> Conversión en Energía
                    </h5>
                    <p>
                        Transformación mediante pirólisis y digestión anaeróbica para generar biogás y electricidad, contribuyendo al suministro energético sostenible de los módulos habitacionales de la base marciana.
                    </p>
                    <button class="btn btn-space btn-space-warning w-100" onclick="simular('energia')">
                        <i class="bi bi-arrow-right-circle me-2"></i> Conversión Energética
                    </button>
                </div>
            </div>

            <!-- Reutilización Creativa -->
            <div class="col-md-6">
                <div class="treatment-card">
                    <i class="bi bi-brush card-icon" style="color: #10b981;"></i>
                    <h5>
                        <i class="bi bi-brush text-success"></i> Reutilización Creativa
                    </h5>
                    <p>
                        Proponé ideas innovadoras para dar nueva vida a objetos no reciclables. La creatividad humana es fundamental para la supervivencia en ambientes extremos como Marte.
                    </p>
                    <form method="post" class="creative-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="idea" class="form-label">
                                <i class="bi bi-lightbulb me-2"></i> Tu Idea Creativa
                            </label>
                            <textarea class="form-control" id="idea" name="idea" rows="3" placeholder="Ej: Usar cables viejos como estructura de soporte para cultivos hidropónicos marcianos..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-space btn-space-success w-100">
                            <i class="bi bi-send-fill me-2"></i> Enviar Idea
                        </button>
                    </form>
                </div>
            </div>

            <!-- Vista de Proceso -->
<div class="col-md-12">
    <div class="treatment-card">
        <i class="bi bi-diagram-3 card-icon" style="color: var(--cosmic-blue);"></i>
        <h5>
            <i class="bi bi-diagram-3 text-primary"></i> Vista de Proceso: Reciclaje de Residuos Inorgánicos
        </h5>
        <p>
            <strong>Resumen Ejecutivo:</strong> Este informe describe el sistema de reciclaje de 12.600 kg de residuos inorgánicos durante una misión marciana de 3 años. Incluye procesos químicos, físicos y biotecnológicos, ecuaciones, diagramas y parámetros operativos.
        </p>

        <div class="accordion" id="procesoReciclaje">
            <!-- Introducción -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="introHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#introCollapse">
                        1. Introducción
                    </button>
                </h2>
                <div id="introCollapse" class="accordion-collapse collapse" data-bs-parent="#procesoReciclaje">
                    <div class="accordion-body">
                        El manejo de residuos inorgánicos es crítico para misiones de larga duración. Se propone un sistema integrado que transforma residuos en materias primas útiles mediante rutas metalúrgicas, poliméricas, compuestas y textiles.
                    </div>
                </div>
            </div>

            <!-- Clasificación -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="clasificacionHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#clasificacionCollapse">
                        2. Clasificación de Residuos
                    </button>
                </h2>
                <div id="clasificacionCollapse" class="accordion-collapse collapse" data-bs-parent="#procesoReciclaje">
                    <div class="accordion-body">
                        <ul>
                            <li>Metales: 25% (~3150 kg)</li>
                            <li>Polímeros y plásticos: 45% (~5670 kg)</li>
                            <li>Textiles y celulosa: 15% (~1890 kg)</li>
                            <li>Envases multicapa: 10% (~1260 kg)</li>
                            <li>Otros (espumas, guantes): 5% (~630 kg)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Procesos Generales -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="procesosHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#procesosCollapse">
                        3. Procesos y Procedimientos Generales
                    </button>
                </h2>
                <div id="procesosCollapse" class="accordion-collapse collapse" data-bs-parent="#procesoReciclaje">
                    <div class="accordion-body">
                        Recepción, clasificación, pretratamiento mecánico, rutas específicas por fracción y procesamiento secundario para obtener productos reutilizables.
                    </div>
                </div>
            </div>

            <!-- Procesos Metalúrgicos -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="metalurgicosHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#metalurgicosCollapse">
                        4. Procesos Metalúrgicos
                    </button>
                </h2>
                <div id="metalurgicosCollapse" class="accordion-collapse collapse" data-bs-parent="#procesoReciclaje">
                    <div class="accordion-body">
                        Fusión, refinado, colado y reacciones como:<br>
                        Al₂O₃ + 3C → 2Al + 3CO<br>
                        Fe₂O₃ + 3H₂ → 2Fe + 3H₂O
                    </div>
                </div>
            </div>

            <!-- Tabla de Parámetros -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="tablaHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tablaCollapse">
                        9. Tabla de Parámetros de Procesos
                    </button>
                </h2>
                <div id="tablaCollapse" class="accordion-collapse collapse" data-bs-parent="#procesoReciclaje">
                    <div class="accordion-body">
                        <table class="table table-sm table-bordered text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Material</th>
                                    <th>Proceso</th>
                                    <th>T (°C)</th>
                                    <th>P (bar)</th>
                                    <th>Objetivo/Salida</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Aluminio</td><td>Fusión/Refinado</td><td>600–800</td><td>1</td><td>Lingotes/Filamento</td></tr>
                                <tr><td>PE / PET</td><td>Extrusión mecánica</td><td>180–260</td><td>1</td><td>Filamento/pellets</td></tr>
                                <tr><td>Plásticos mixtos</td><td>Pirolisis</td><td>400–700</td><td>&lt;1</td><td>Aceite/Gas/Char</td></tr>
                                <tr><td>CFRP</td><td>Solvolisis/Pirolisis</td><td>200–500</td><td>1–10</td><td>Fibras recuperadas</td></tr>
                                <tr><td>Textiles</td><td>Hidrólisis</td><td>100–180</td><td>1–5</td><td>Azúcares / Paneles</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recomendaciones -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="recomendacionesHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#recomendacionesCollapse">
                        10. Discusión y Recomendaciones
                    </button>
                </h2>
                <div id="recomendacionesCollapse" class="accordion-collapse collapse" data-bs-parent="#procesoReciclaje">
                    <div class="accordion-body">
                        Implementación modular, validación con ensayos, pruebas en Tierra y simulación de microgravedad.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</section>

<!-- Modal de Simulación -->
<div class="modal fade modal-space" id="simModal" tabindex="-1" aria-labelledby="simModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="simModalLabel">
                    <i class="bi bi-cpu me-2"></i> Simulación en Progreso
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="simAnimacion" class="processing-animation">
                    <div class="spinner-custom"></div>
                    <p class="lead" style="color: var(--warning-orange);">
                        <i class="bi bi-gear-fill me-2"></i> Procesando estrategia de tratamiento...
                    </p>
                    <p style="color: rgba(232, 232, 232, 0.7); font-size: 0.9rem;">
                        Analizando parámetros ambientales y calculando eficiencia energética
                    </p>
                </div>
                <div id="simResultado" class="d-none result-animation">
                    <div class="text-center">
                        <i id="simIcono" class="result-icon bi bi-check-circle-fill" style="color: #10b981;"></i>
                        <h4 style="color: var(--warning-orange); margin-bottom: 20px;">Proceso Completado</h4>
                        <p class="mb-4" id="simTexto" style="color: var(--star-white); font-size: 1.1rem;"></p>
                    </div>
                    <div class="graph-container">
                        <h6 style="color: var(--cosmic-blue); text-align: center; margin-bottom: 15px;">
                            <i class="bi bi-bar-chart-fill me-2"></i> Análisis de Distribución
                        </h6>
                        <img id="graficoSimulacion" src="{% static 'residuos_no_reciclables/img/distribucion_residuos_no_reciclables.png' %}" alt="Gráfico de distribución" class="img-fluid w-100">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-space btn-space-primary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function simular(tipo) {
    const mensajes = {
        compactacion: {
            texto: "Los residuos han sido compactados exitosamente mediante prensas hidráulicas y almacenados en contenedores blindados de nivel 4. Sistema de rastreo activado para monitoreo continuo.",
            icono: "bi-box-fill",
            color: "#3b82f6",
            titulo: "Compactación y Almacenamiento"
        },
        incineracion: {
            texto: "Incineración completada con éxito. Temperatura alcanzada: 1,200°C. Filtros HEPA activados y neutralización de gases tóxicos confirmada. Volumen reducido en un 87%. Cenizas seguras para análisis.",
            icono: "bi-fire",
            color: "#ef4444",
            titulo: "Incineración Controlada"
        },
        energia: {
            texto: "Conversión energética completada exitosamente. Se ha generado 2.4 kWh de energía eléctrica y 15m³ de biogás utilizable. Módulo de comunicaciones alimentado por 6 horas.",
            icono: "bi-lightning-fill",
            color: "#FF6B35",
            titulo: "Conversión en Energía"
        },
        reutilizacion: {
            texto: "Idea registrada exitosamente en la base de datos de innovación marciana. ¡La creatividad humana es esencial para superar los desafíos de la colonización espacial!",
            icono: "bi-brush",
            color: "#10b981",
            titulo: "Reutilización Creativa"
        }
    };

    const modal = new bootstrap.Modal(document.getElementById("simModal"));
    const animacion = document.getElementById("simAnimacion");
    const resultado = document.getElementById("simResultado");
    const texto = document.getElementById("simTexto");
    const icono = document.getElementById("simIcono");
    const titulo = document.getElementById("simModalLabel");

    // Mostrar modal y animación
    animacion.classList.remove("d-none");
    resultado.classList.add("d-none");

    const datos = mensajes[tipo];
   titulo.innerHTML = `<i class="bi bi-cpu me-2"></i> Simulación: ${datos.titulo}`;
texto.textContent = datos.texto;
icono.className = `result-icon bi ${datos.icono}`;
icono.style.color = datos.color;

    modal.show();

    // Llamar a la vista que genera el gráfico
    fetch("{% url 'residuos_no_reciclables:generar_grafico' %}")
        .then(response => {
            if (!response.ok) {
                throw new Error("Error al generar gráfico");
            }
            return response.json();
        })
        .then(data => {
            setTimeout(() => {
                animacion.classList.add("d-none");
                resultado.classList.remove("d-none");

                // Recargar imagen del gráfico sin caché
                const grafico = document.getElementById("graficoSimulacion");
                grafico.src = "{% static 'residuos_no_reciclables/img/distribucion_residuos_no_reciclables.png' %}?" + new Date().getTime();
            }, 2500);
        })
        .catch(error => {
            console.error("Error en la simulación:", error);
            texto.textContent = "Hubo un error al generar el gráfico de análisis. Por favor, intente nuevamente.";
            icono.className = "result-icon bi-exclamation-triangle-fill";
            icono.style.color = "#ef4444";
            animacion.classList.add("d-none");
            resultado.classList.remove("d-none");
        });
}
</script>

{% endblock %}